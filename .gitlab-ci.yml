image: ubuntu:16.04

before_script:
- apt-get update -yqq
- apt-get install sudo git subversion build-essential libncurses5-dev zlib1g-dev gawk unzip libxml-perl flex wget gawk libncurses5-dev gettext quilt python libssl-dev rsync -yqq

cache:
    key: "$CI_BUILD_REF_NAME"
    paths:
     - dl

build:prepare:
    stage: prepare
    script:
     - chown -R nobody . 
     - sudo -u nobody make prepare
     - sudo -u nobody cd lede && make prepare -j$(nproc)
    artifacts:
     paths:
      - lede 
     expire_in: 1 day 

build:ar71xx:
    stage: build
    script:
     - chown -R nobody .
     - sudo -u nobody make TARGET=ar71xx -j$(nproc)
    artifacts:
     paths:
      - firmwares
     expire_in: 1 day
    dependencies: 
	- build:prepare

build:ramips_mt7620:
    stage: build
    script:
     - chown -R nobody .
     - sudo -u nobody make TARGET=ramips_mt7620 -j$(nproc)
    artifacts:
     paths:
      - firmwares
     expire_in: 1 day
    dependencies: 
	- build:prepare

build:ramips_mt7628:
    stage: build
    script:
     - chown -R nobody .
     - sudo -u nobody make TARGET=ramips_mt7628 -j$(nproc)
    artifacts:
     paths:
      - firmwares
     expire_in: 1 day
    dependencies: 
	- build:prepare 

build:x86:
    stage: build
    script:
     - chown -R nobody .
     - sudo -u nobody make TARGET=x86 -j$(grep ^processor /proc/cpuinfo | wc -l)
     - cd lede; sudo -u nobody make clean
    artifacts:
     paths:
      - firmwares
     expire_in: 1 day
    dependencies:
	- build:prepare 


build:uml:
    stage: build
    script:
     - chown -R nobody .
     - sudo -u nobody make TARGET=uml -j$(grep ^processor /proc/cpuinfo | wc -l)
     - cd lede; sudo -u nobody make clean
    artifacts:
     paths:
      - firmwares
     expire_in: 1 day
    dependencies:
	- prepare
             
deploy:
    stage: deploy
    script:
     - eval $(ssh-agent -s) 
     - ssh-add <(echo "${SSH_PRIVATE_KEY}") 
     - echo "${SSH_HOST_KEY}" > hostkey 
     - rsync -hrvz -e 'ssh -o "UserKnownHostsFile hostkey"' firmwares firmware@weimarnetz.segfault.gq:/
